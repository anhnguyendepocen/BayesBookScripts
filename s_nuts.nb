(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     51342,       1303]
NotebookOptionsPosition[     49888,       1250]
NotebookOutlinePosition[     50251,       1266]
CellTagsIndexPosition[     50208,       1263]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ";"}]], "Input",
 CellChangeTimes->{{3.752238819415077*^9, 3.752238826229746*^9}, {
  3.752239964338439*^9, 3.752239964499198*^9}, {3.752246926696396*^9, 
  3.7522469269579763`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"f", "[", "x__", "]"}], ":=", 
  RowBox[{
   RowBox[{"Log", "[", 
    RowBox[{"PDF", "[", 
     RowBox[{
      RowBox[{"MultinormalDistribution", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"5", ",", "5"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"1.5", ",", "0.25"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"0.25", ",", "1.5"}], "}"}]}], "}"}]}], "]"}], ",", 
      RowBox[{"{", "x", "}"}]}], "]"}], "]"}], "[", 
   RowBox[{"[", "1", "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fDerivative", "[", 
   RowBox[{"f_", ",", "z_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"x", ",", "v"}], "}"}], ",", 
    RowBox[{
     RowBox[{"v", "=", 
      RowBox[{"Array", "[", 
       RowBox[{"x", ",", 
        RowBox[{"Length", "[", "z", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"D", "[", 
       RowBox[{
        RowBox[{"f", "@@", "v"}], ",", 
        RowBox[{"{", "v", "}"}]}], "]"}], "/.", 
      RowBox[{"Thread", "[", 
       RowBox[{"v", "\[Rule]", "z"}], "]"}]}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fLeapFrogStep", "[", 
   RowBox[{"\[Theta]_", ",", "m_", ",", "\[Epsilon]_", ",", "logP_"}], "]"}], 
  ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"grad", ",", "x", ",", "\[Theta]1", ",", "m1", ",", "grad1"}], 
     "}"}], ",", 
    RowBox[{
     RowBox[{"grad", "=", 
      RowBox[{"fDerivative", "[", 
       RowBox[{"logP", ",", "\[Theta]"}], "]"}]}], ";", 
     RowBox[{"m1", "=", 
      RowBox[{"m", "+", 
       RowBox[{"0.5", " ", "\[Epsilon]", " ", "grad"}]}]}], ";", " ", 
     RowBox[{"\[Theta]1", "=", 
      RowBox[{"\[Theta]", "+", 
       RowBox[{"\[Epsilon]", " ", "m1"}]}]}], ";", 
     RowBox[{"grad1", "=", 
      RowBox[{"fDerivative", "[", 
       RowBox[{"logP", ",", "\[Theta]1"}], "]"}]}], ";", 
     RowBox[{"m1", "=", 
      RowBox[{"m1", "+", 
       RowBox[{"0.5", " ", "\[Epsilon]", " ", "grad1"}]}]}], ";", 
     RowBox[{"{", 
      RowBox[{"\[Theta]1", ",", "m1"}], "}"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fBuildTree", "[", 
   RowBox[{
   "\[Theta]_", ",", "m_", ",", "u_", ",", "v_", ",", "j_", ",", 
    "\[Epsilon]_", ",", "logP_", ",", "\[CapitalDelta]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "Cprimed", ",", "Cprimedprimed", ",", "sprimed", ",", "sprimedprimed", 
      ",", "res", ",", "thetaMinus", ",", "thetaPlus", ",", "mMinus", ",", 
      "mPlus", ",", "temp1", ",", "temp2"}], "}"}], ",", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"j", "\[Equal]", "0"}], ",", 
      RowBox[{
       RowBox[{"res", "=", 
        RowBox[{"fLeapFrogStep", "[", 
         RowBox[{"\[Theta]", ",", "m", ",", 
          RowBox[{"v", " ", "\[Epsilon]"}], ",", "logP"}], "]"}]}], ";", 
       RowBox[{"Cprimed", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Log", "[", "u", "]"}], "\[LessEqual]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"logP", "[", 
              RowBox[{"res", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "]"}], "-", 
             RowBox[{"0.5", " ", 
              RowBox[{"m", ".", "m"}]}]}], ")"}]}], ",", "res", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"res", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"res", "[", 
             RowBox[{"[", "2", "]"}], "]"}], ",", 
            RowBox[{"{", "}"}]}], "}"}]}], "]"}]}], ";", 
       RowBox[{"sprimed", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Log", "[", "u", "]"}], "<", 
           RowBox[{"(", 
            RowBox[{"\[CapitalDelta]", "+", 
             RowBox[{"logP", "[", 
              RowBox[{"res", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "]"}], "-", 
             RowBox[{"0.5", " ", 
              RowBox[{"m", ".", "m"}]}]}], ")"}]}], ",", "1", ",", "0"}], 
         "]"}]}], ";", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"res", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"res", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", 
         RowBox[{"res", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"res", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", "Cprimed", ",", "sprimed"}], 
        "}"}]}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "thetaMinus", ",", "mMinus", ",", "thetaPlus", ",", "mPlus", ",", 
          "Cprimed", ",", "sprimed"}], "}"}], "=", 
        RowBox[{"fBuildTree", "[", 
         RowBox[{"\[Theta]", ",", "m", ",", "u", ",", "v", ",", 
          RowBox[{"j", "-", "1"}], ",", "\[Epsilon]", ",", "logP", ",", 
          "\[CapitalDelta]"}], "]"}]}], ";", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"v", "\[Equal]", 
          RowBox[{"-", "1"}]}], ",", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "thetaMinus", ",", "mMinus", ",", "temp1", ",", "temp2", ",", 
            "Cprimedprimed", ",", "sprimedprimed"}], "}"}], "=", 
          RowBox[{"fBuildTree", "[", 
           RowBox[{"thetaMinus", ",", "mMinus", ",", "u", ",", "v", ",", 
            RowBox[{"j", "-", "1"}], ",", "\[Epsilon]", ",", "logP", ",", 
            "\[CapitalDelta]"}], "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "temp1", ",", "temp2", ",", "thetaPlus", ",", "mPlus", ",", 
            "Cprimedprimed", ",", "sprimedprimed"}], "}"}], "=", 
          RowBox[{"fBuildTree", "[", 
           RowBox[{"thetaPlus", ",", "mMinus", ",", "u", ",", "v", ",", 
            RowBox[{"j", "-", "1"}], ",", "\[Epsilon]", ",", "logP", ",", 
            "\[CapitalDelta]"}], "]"}]}]}], "]"}], ";", 
       RowBox[{"sprimed", "=", 
        RowBox[{"sprimed", " ", "sprimedprimed", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", 
             "mMinus"}], " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", 
           "0"}], "]"}], 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", "mPlus"}],
             " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", "0"}], 
          "]"}]}]}], ";", 
       RowBox[{"Cprimed", " ", "=", " ", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{
          RowBox[{"Union", "[", 
           RowBox[{
            RowBox[{"{", "Cprimed", "}"}], ",", 
            RowBox[{"{", "Cprimedprimed", "}"}]}], "]"}], ",", 
          RowBox[{"{", "}"}]}], "]"}]}], ";", " ", 
       RowBox[{"{", 
        RowBox[{
        "thetaMinus", ",", "mMinus", ",", "thetaPlus", ",", "mPlus", ",", 
         "Cprimed", ",", "sprimed"}], "}"}]}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTSstep", "[", 
   RowBox[{
   "\[Theta]_", ",", "\[Epsilon]_", ",", "logP_", ",", "\[CapitalDelta]_"}], 
   "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"thetaMinus", "=", "\[Theta]"}], ",", 
      RowBox[{"thetaPlus", "=", "\[Theta]"}], ",", "mMinus", ",", "mPlus", 
      ",", 
      RowBox[{"j", "=", "0"}], ",", "C", ",", 
      RowBox[{"s", "=", "1"}], ",", "m", ",", "temp1", ",", "temp2", ",", 
      "Cprimed", ",", "sprimed", ",", "u", ",", "v"}], "}"}], ",", 
    RowBox[{
     RowBox[{"m", "=", 
      RowBox[{
       RowBox[{"RandomVariate", "[", 
        RowBox[{
         RowBox[{"MultinormalDistribution", "[", 
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", 
             RowBox[{"Length", "@", "\[Theta]"}]}], "]"}], ",", 
           RowBox[{"IdentityMatrix", "[", 
            RowBox[{"Length", "@", "\[Theta]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", "1", "}"}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", 
     RowBox[{"u", "=", 
      RowBox[{
       RowBox[{"RandomVariate", "[", 
        RowBox[{
         RowBox[{"UniformDistribution", "[", 
          RowBox[{"{", 
           RowBox[{"0", ",", 
            RowBox[{"Exp", "[", 
             RowBox[{
              RowBox[{"logP", "[", "\[Theta]", "]"}], "-", 
              RowBox[{"0.5", " ", 
               RowBox[{"m", ".", "m"}]}]}], "]"}]}], "}"}], "]"}], ",", "1"}],
         "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"mMinus", "=", "m"}], ";", 
     RowBox[{"mPlus", "=", "m"}], ";", 
     RowBox[{"C", "=", 
      RowBox[{"{", 
       RowBox[{"\[Theta]", ",", "m"}], "}"}]}], ";", 
     RowBox[{"While", "[", 
      RowBox[{
       RowBox[{"s", "\[Equal]", "1"}], ",", 
       RowBox[{
        RowBox[{"v", "=", 
         RowBox[{"RandomChoice", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "1"}], ",", "1"}], "}"}], "]"}]}], ";", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"v", "\[Equal]", 
           RowBox[{"-", "1"}]}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "thetaMinus", ",", "mMinus", ",", "temp1", ",", "temp2", ",", 
             "Cprimed", ",", "sprimed"}], "}"}], "=", 
           RowBox[{"fBuildTree", "[", 
            RowBox[{
            "thetaMinus", ",", "mMinus", ",", "u", ",", "v", ",", "j", ",", 
             "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}], 
          ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "temp1", ",", "temp2", ",", "thetaPlus", ",", "mPlus", ",", 
             "Cprimed", ",", "sprimed"}], "}"}], "=", 
           RowBox[{"fBuildTree", "[", 
            RowBox[{
            "thetaPlus", ",", "mPlus", ",", "u", ",", "v", ",", "j", ",", 
             "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}]}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"sprimed", "\[Equal]", "1"}], ",", 
          RowBox[{"C", "=", 
           RowBox[{"Union", "[", 
            RowBox[{
             RowBox[{"{", "C", "}"}], ",", 
             RowBox[{"{", "Cprimed", "}"}]}], "]"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"s", "=", 
         RowBox[{"sprimed", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", 
              "mMinus"}], " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", 
            "0"}], "]"}], 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", 
              "mPlus"}], " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", 
            "0"}], "]"}]}]}], ";", 
        RowBox[{"j", " ", "=", " ", 
         RowBox[{"j", " ", "+", " ", "1"}]}]}]}], "]"}], ";", "C"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTSstepExtract", "[", "c_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"dep", "=", 
      RowBox[{"Depth", "@", "c"}]}], "}"}], ",", 
    RowBox[{"RandomChoice", "@", 
     RowBox[{"DeleteCases", "[", 
      RowBox[{
       RowBox[{"Flatten", "[", 
        RowBox[{"c", ",", 
         RowBox[{"dep", "-", "4"}]}], "]"}], ",", 
       RowBox[{"{", "}"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTSstepComplete", "[", 
   RowBox[{
   "\[Theta]_", ",", "\[Epsilon]_", ",", "logP_", ",", "\[CapitalDelta]_"}], 
   "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"c", "=", 
      RowBox[{"fNUTSstep", "[", 
       RowBox[{
       "\[Theta]", ",", "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], 
       "]"}]}], "}"}], ",", 
    RowBox[{"fNUTSstepExtract", "[", "c", "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTS", "[", 
   RowBox[{
   "M_Integer", ",", "\[Theta]0_", ",", "\[Epsilon]_", ",", "logP_", ",", 
    "\[CapitalDelta]_"}], "]"}], ":=", 
  RowBox[{"NestList", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"fNUTSstepComplete", "[", 
      RowBox[{
       RowBox[{"#", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", "\[Epsilon]", ",", "logP", ",", 
       "\[CapitalDelta]"}], "]"}], "&"}], ",", 
    RowBox[{"{", 
     RowBox[{"\[Theta]0", ",", 
      RowBox[{"{", "}"}]}], "}"}], ",", "M"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.752241656626203*^9, 3.752241701486404*^9}, {
   3.7522417374734*^9, 3.752241828537655*^9}, {3.752241868186348*^9, 
   3.7522418879097*^9}, {3.7522419918601017`*^9, 3.752242187343792*^9}, {
   3.7522422198022842`*^9, 3.752242223177862*^9}, {3.752242261379641*^9, 
   3.752242497584846*^9}, {3.752242537963459*^9, 3.7522425493917522`*^9}, {
   3.752242585883156*^9, 3.7522426865105333`*^9}, {3.752242723633382*^9, 
   3.7522428295423803`*^9}, 3.752242860112129*^9, {3.7522429132236443`*^9, 
   3.752243078848131*^9}, {3.752244128999853*^9, 3.7522441343109007`*^9}, {
   3.7522469086878147`*^9, 3.752246915785604*^9}, {3.752247355933969*^9, 
   3.752247381790059*^9}, {3.75224824179998*^9, 3.7522482454229517`*^9}, {
   3.752252301841056*^9, 3.7522523054725847`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"samples", "=", 
   RowBox[{"fNUTS", "[", 
    RowBox[{"50", ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "0"}], "}"}], ",", "0.1", ",", "f", ",", "1000"}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.752246461818357*^9, 3.75224647383322*^9}, 
   3.752246503892144*^9, 3.7522465378697*^9, {3.7522474117164583`*^9, 
   3.7522474352935667`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ListLinePlot", "[", 
  RowBox[{"samples", "[", 
   RowBox[{"[", 
    RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.752246488356022*^9, 3.752246492579344*^9}, {
  3.752246960008864*^9, 3.752246961343184*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, {}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.016666666666666666`],
      AbsoluteThickness[1.6], LineBox[CompressedData["
1:eJxlkmtMUwcARivaAhb1tvfe3lsvs+0U56huw6oIU+5HjQZczcD4GAoWiEVa
wUqEdQHxQViUDWsi4FhZLJmPTg3iiFoeYYRtvsoQFgEn8lASUQIoCg4s1E7/
ui85OTn/P1WyeaPBRyAQaN7yzu8vSrfloa1zsKEl9M0rxy9i6F3XWNfeNzyz
Z0xovP6at2mybelVcswWBa+0XlRifkGp+ewyFvl9phb7HSV6DKNHEmsp/NtY
TywQK9HOMeMvezio/5aGmD9goPlY3ZxTxkA93FP/vUGMeySfXPOMho/q0uSr
SRbELlvFyUkZDskvR44blRgYETRzxwIRm0CPL3Cp0HQ5LH67g4a4/3hRec8Q
/3VrS1JqFYWSgMH9uuVTfP5idiTiIIE11YoD/nYv32lpf7qfYdBbWvHtinvT
sEFxoUu9WYI4crBrj4ZBeATZsZInIFN6OnU/zsVkvyEy4K4Uu61lpxbbGRQ2
2Vb7l5F49NLi7P1SgjvEDtJEydEd4/2THSDgDNXmjgZN8LcuaGu82TRq06gb
m1TT8Xh3tSh/UIYlq0oo6U0GfY4X218HiTFbnOSqDKRhPZd1vOu0GO3fffVN
4QMOW25XKvv8KBxpvRr3QMUhPfZTUXwOg5O13ZembQ3ErF3O7jwzi7Nnyl3b
aiSgJg5b1sgJ/KxN8w1/5o+8fUs//Jyl4T5dvfxutB8OKjLcokIpLKbEoUbt
DDQYu65ob0hxqDFB8kc0i0Lf/H7dbxSekM36kg4akQXJfymL5uBU+cYcx0cy
uBOOCjy/y2AJ9ISYMjiMxlb7MVEsdCf6U+qmODTldQxHxbOo4c7dEnIcNh1Q
DEsaaKwWneep8wymRBNfCCoJfGZodzgHGGQX2ZdmjBH4wbd3kcbLoPT+Ty/a
hv7fVfqF0lo7i3BjzDqBh0SY5VpicKmXf7Lzk30Fv1JIW6SKSc0d4WcUZ244
kR0Ar5ALa9OrEDxvbG1kOgmr5KHb6kMjwFdPFWfK0Jq4LK8zRwbO5FYEPZch
Yt7MouC3/1u/4p/M6ylynBmNmyVUzwQ5R+hJyqIRv8RpXLdTjIsZ4dbN0RSK
d5iTtl3l0O1X9yi3gsJ/Gy9SJQ==
      "]]}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{-0.8704351789077771, 8.687166008518941}, {
    0, 8.894813271863912}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{{3.7522464928876534`*^9, 3.752246513819666*^9}, 
   3.752246589659252*^9, 3.7522468382287617`*^9, 3.752246961916052*^9, 
   3.752247429563388*^9, 3.752247503737941*^9, 3.752248548789719*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Visualising tree", "Section",
 CellChangeTimes->{{3.752246840122805*^9, 3.7522468578343477`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"tree", "=", 
   RowBox[{"fNUTSstep", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"5", ",", "5"}], "}"}], ",", "0.1", ",", "f", ",", "1000"}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.752248327663561*^9, 3.752248361936473*^9}, {
  3.752248436347795*^9, 3.752248436731289*^9}, {3.7522484708134623`*^9, 
  3.752248485896097*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Depth", "@", "tree"}]], "Input",
 CellChangeTimes->{{3.752248489427951*^9, 3.752248491709485*^9}}],

Cell[BoxData["14"], "Output",
 CellChangeTimes->{3.7522484921206827`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"tree", "[", 
  RowBox[{"[", 
   RowBox[{
   "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", 
    ",", "2", ",", "All", ",", "1"}], "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.7522484937986183`*^9, 3.7522485410858088`*^9}, {
  3.752248571807742*^9, 3.752248608442954*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"3.2660339205551625`", ",", "6.271641482515137`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3.319551085725042`", ",", "6.2324397795312505`"}], "}"}]}], 
  "}"}]], "Output",
 CellChangeTimes->{{3.752248496025313*^9, 3.752248541748124*^9}, {
  3.75224857230893*^9, 3.7522486087984447`*^9}}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"fTree", "[", "lpoints__", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"Arrow", "[", "#", "]"}], "&"}], "@", "lpoints"}]}]], "Input",
 CellChangeTimes->{{3.7522486151823673`*^9, 3.752248687350647*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Graphics", "[", 
  RowBox[{"fTree", "[", 
   RowBox[{"tree", "[", 
    RowBox[{"[", 
     RowBox[{
     "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", 
      "1", ",", "All", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.752248667735138*^9, 3.752248725874072*^9}}],

Cell[BoxData[
 GraphicsBox[
  ArrowBox[{{{3.1591905649096823`, 6.349891734321995}, {3.212507200036846, 
   6.310850851614628}}, {{3.2660339205551625`, 6.271641482515137}, {
   3.319551085725042, 6.2324397795312505`}}}]]], "Output",
 CellChangeTimes->{{3.752248670680752*^9, 3.752248726392105*^9}}]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{"fNUTSstepSingle", "[", 
   RowBox[{
   "\[Theta]_", ",", "\[Epsilon]_", ",", "logP_", ",", "\[CapitalDelta]_"}], 
   "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"thetaMinus", "=", "\[Theta]"}], ",", 
      RowBox[{"thetaPlus", "=", "\[Theta]"}], ",", "mMinus", ",", "mPlus", 
      ",", 
      RowBox[{"j", "=", "0"}], ",", "C", ",", 
      RowBox[{"s", "=", "1"}], ",", "m", ",", "temp1", ",", "temp2", ",", 
      "Cprimed", ",", "sprimed", ",", "u", ",", "v"}], "}"}], ",", 
    RowBox[{
     RowBox[{"m", "=", 
      RowBox[{
       RowBox[{"RandomVariate", "[", 
        RowBox[{
         RowBox[{"MultinormalDistribution", "[", 
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", 
             RowBox[{"Length", "@", "\[Theta]"}]}], "]"}], ",", 
           RowBox[{"IdentityMatrix", "[", 
            RowBox[{"Length", "@", "\[Theta]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", "1", "}"}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", 
     RowBox[{"u", "=", 
      RowBox[{
       RowBox[{"RandomVariate", "[", 
        RowBox[{
         RowBox[{"UniformDistribution", "[", 
          RowBox[{"{", 
           RowBox[{"0", ",", 
            RowBox[{"Exp", "[", 
             RowBox[{
              RowBox[{"logP", "[", "\[Theta]", "]"}], "-", 
              RowBox[{"0.5", " ", 
               RowBox[{"m", ".", "m"}]}]}], "]"}]}], "}"}], "]"}], ",", "1"}],
         "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"mMinus", "=", "m"}], ";", 
     RowBox[{"mPlus", "=", "m"}], ";", 
     RowBox[{"C", "=", 
      RowBox[{"{", 
       RowBox[{"\[Theta]", ",", "m"}], "}"}]}], ";", 
     RowBox[{"v", "=", 
      RowBox[{"RandomChoice", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", "1"}], ",", "1"}], "}"}], "]"}]}], ";", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"v", "\[Equal]", 
        RowBox[{"-", "1"}]}], ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "thetaMinus", ",", "mMinus", ",", "temp1", ",", "temp2", ",", 
          "Cprimed", ",", "sprimed"}], "}"}], "=", 
        RowBox[{"fBuildTree", "[", 
         RowBox[{
         "thetaMinus", ",", "mMinus", ",", "u", ",", "v", ",", "j", ",", 
          "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}], ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "temp1", ",", "temp2", ",", "thetaPlus", ",", "mPlus", ",", 
          "Cprimed", ",", "sprimed"}], "}"}], "=", 
        RowBox[{"fBuildTree", "[", 
         RowBox[{
         "thetaPlus", ",", "mPlus", ",", "u", ",", "v", ",", "j", ",", 
          "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"sprimed", "\[Equal]", "1"}], ",", 
       RowBox[{"C", "=", 
        RowBox[{"Union", "[", 
         RowBox[{
          RowBox[{"{", "C", "}"}], ",", 
          RowBox[{"{", "Cprimed", "}"}]}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"s", "=", 
      RowBox[{"sprimed", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", "mMinus"}], 
          " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", "0"}], "]"}], 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"thetaPlus", "-", "thetaMinus"}], ")"}], ".", "mPlus"}], 
          " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", "0"}], "]"}]}]}],
      ";", 
     RowBox[{"j", " ", "=", " ", 
      RowBox[{"j", " ", "+", " ", "1"}]}], ";", "C"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTSstepSingleString", "[", 
   RowBox[{
   "thetaMinus_", ",", "mMinus_", ",", "thetaPlus_", ",", "mPlus_", ",", "C_",
     ",", "j_", ",", "s_", ",", "u_", ",", "\[Epsilon]_", ",", "logP_", ",", 
    "\[CapitalDelta]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"thetaMinus1", "=", "thetaMinus"}], ",", 
      RowBox[{"mMinus1", "=", "mMinus"}], ",", 
      RowBox[{"thetaPlus1", "=", "thetaPlus"}], ",", 
      RowBox[{"mPlus1", "=", "mPlus"}], ",", 
      RowBox[{"s1", "=", "s"}], ",", "temp1", ",", "temp2", ",", "Cprimed", 
      ",", "sprimed", ",", "v", ",", "C1", ",", "j1", ",", "dep"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"v", "=", 
      RowBox[{"RandomChoice", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", "1"}], ",", "1"}], "}"}], "]"}]}], ";", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"v", "\[Equal]", 
        RowBox[{"-", "1"}]}], ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "thetaMinus1", ",", "mMinus1", ",", "temp1", ",", "temp2", ",", 
          "Cprimed", ",", "sprimed"}], "}"}], "=", 
        RowBox[{"fBuildTree", "[", 
         RowBox[{
         "thetaMinus1", ",", "mMinus1", ",", "u", ",", "v", ",", "j", ",", 
          "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}], ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "temp1", ",", "temp2", ",", "thetaPlus1", ",", "mPlus1", ",", 
          "Cprimed", ",", "sprimed"}], "}"}], "=", 
        RowBox[{"fBuildTree", "[", 
         RowBox[{
         "thetaPlus1", ",", "mPlus", ",", "u", ",", "v", ",", "j", ",", 
          "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"dep", "=", 
      RowBox[{
       RowBox[{"Depth", "@", "Cprimed"}], "-", "4"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"sprimed", "\[Equal]", "1"}], ",", 
       RowBox[{"C1", "=", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", "C", "}"}], ",", 
          RowBox[{"{", "Cprimed", "}"}]}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"s1", "=", 
      RowBox[{"sprimed", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"thetaPlus1", "-", "thetaMinus1"}], ")"}], ".", 
           "mMinus1"}], " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", 
         "0"}], "]"}], 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"thetaPlus1", "-", "thetaMinus1"}], ")"}], ".", 
           "mPlus1"}], " ", "\[GreaterEqual]", " ", "0"}], ",", "1", ",", 
         "0"}], "]"}]}]}], ";", 
     RowBox[{"j1", " ", "=", " ", 
      RowBox[{"j", " ", "+", " ", "1"}]}], ";", 
     RowBox[{"{", 
      RowBox[{
      "thetaMinus1", ",", " ", "mMinus1", ",", " ", "thetaPlus1", ",", " ", 
       "mPlus1", ",", "C1", ",", "j1", ",", "s1", ",", "u", ",", "\[Epsilon]",
        ",", "logP", ",", "\[CapitalDelta]"}], "}"}]}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.7522488050062304`*^9, 3.752248829702606*^9}, {
   3.752248876538212*^9, 3.752248880225648*^9}, {3.7522489107154493`*^9, 
   3.7522489231232224`*^9}, {3.752248989231635*^9, 3.752249058417417*^9}, {
   3.752249218754447*^9, 3.752249228504674*^9}, {3.7522493394548483`*^9, 
   3.752249347614276*^9}, {3.75224943326779*^9, 3.7522494376903057`*^9}, {
   3.752249494356967*^9, 3.752249713279314*^9}, {3.7522497530902567`*^9, 
   3.752249753433041*^9}, {3.752249861990279*^9, 3.752249868983016*^9}, {
   3.752250643859624*^9, 3.752250648698619*^9}, {3.7522507211576967`*^9, 
   3.7522507449573517`*^9}, 3.752250881108919*^9, {3.752251084903672*^9, 
   3.752251178658659*^9}, {3.752251224932941*^9, 3.752251262230258*^9}, {
   3.752251311762228*^9, 3.752251334458077*^9}, {3.752251495826542*^9, 
   3.752251618510818*^9}, {3.752251705371059*^9, 3.752251719043494*^9}, {
   3.752251754390787*^9, 3.7522517789022617`*^9}, {3.752251863706205*^9, 
   3.752251885787624*^9}, {3.75225205344453*^9, 3.752252071147408*^9}, {
   3.752252120061808*^9, 3.75225214470299*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"fNUTSstepSingle", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", "0.1", ",", "f", ",", "1000"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.7522488328627577`*^9, 3.7522488425815153`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"0.9578686047110776`", ",", "0.9016119599362838`"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"-", "0.42131299460198146`"}], ",", 
       RowBox[{"-", "0.9838794236259599`"}]}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"-", "0.42131526855519424`"}], ",", 
       RowBox[{"-", "0.9838817163031321`"}]}], "}"}]}], "}"}]}], 
  "}"}]], "Output",
 CellChangeTimes->{{3.7522488429431257`*^9, 3.7522488503637943`*^9}, 
   3.7522507520497923`*^9, 3.7522520729130783`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"fNUTSstepSingleString", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.5", ",", "0.5"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.5", ",", "0.5"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0.5", ",", "0.5"}], "}"}]}], "}"}], ",", "0", ",", "0", ",", 
   "0.001", ",", " ", "0.1", ",", " ", "f", ",", "1000"}], "]"}]], "Input",
 CellChangeTimes->{{3.752249766753667*^9, 3.752249816930517*^9}, {
  3.752249878598468*^9, 3.75224989830304*^9}, {3.752249963001917*^9, 
  3.752249970226468*^9}, {3.752251965662115*^9, 3.752251973350618*^9}, {
  3.752252019520639*^9, 3.752252034625301*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.5`", ",", "0.5`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1.050000131566597`", ",", "1.050000131566597`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.5000029462000448`", ",", "0.5000029462000448`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0.5`", ",", "0.5`"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1.050000131566597`", ",", "1.050000131566597`"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"0.5000029462000448`", ",", "0.5000029462000448`"}], "}"}]}], 
      "}"}], ",", 
     RowBox[{"{", "}"}]}], "}"}], ",", "1", ",", "1", ",", "0.001`", ",", 
   "0.1`", ",", "f", ",", "1000"}], "}"}]], "Output",
 CellChangeTimes->{{3.7522520314340677`*^9, 3.752252034925447*^9}, 
   3.752252073715342*^9}]
}, Open  ]],

Cell[BoxData[{
 RowBox[{"Clear", "[", "fNUTSstring", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fNUTSstring", "[", 
   RowBox[{
   "depth_Integer", ",", "theta0_", ",", "m0_", ",", "u_", ",", "\[Epsilon]_",
     ",", "logP_", ",", "\[CapitalDelta]_"}], "]"}], ":=", 
  RowBox[{"NestWhileList", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"fNUTSstepSingleString", "@@", "#"}], "&"}], ",", 
    RowBox[{"{", 
     RowBox[{"theta0", ",", "m0", ",", "theta0", ",", "m0", ",", 
      RowBox[{"{", 
       RowBox[{"theta0", ",", "m0"}], "}"}], ",", "0", ",", "1", ",", "u", 
      ",", "\[Epsilon]", ",", "logP", ",", "\[CapitalDelta]"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "[", 
       RowBox[{"[", "7", "]"}], "]"}], "\[Equal]", "1"}], " ", "&"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.752249912367115*^9, 3.752249930743882*^9}, {
   3.752249978586282*^9, 3.75225018580376*^9}, {3.752250254872417*^9, 
   3.752250301497896*^9}, {3.752250485740239*^9, 3.752250537365409*^9}, 
   3.752250587102705*^9, {3.7522507805208483`*^9, 3.752250788007677*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"fNUTSstring", "[", 
    RowBox[{"4", ",", 
     RowBox[{"{", 
      RowBox[{"4.8", ",", "5"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0.1", ",", 
       RowBox[{"-", "0.4"}]}], "}"}], ",", "0.001", ",", "0.5", ",", "f", ",",
      "1000"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.752250187702857*^9, 3.752250213716765*^9}, {
   3.752250294089279*^9, 3.752250310507221*^9}, {3.752250377364913*^9, 
   3.7522503785087337`*^9}, 3.752250501210841*^9, 3.752250545964579*^9, 
   3.7522505791423264`*^9, {3.75225083428312*^9, 3.7522508558744993`*^9}, 
   3.752250909350605*^9, {3.752250969744042*^9, 3.7522509773919277`*^9}, {
   3.75225268868091*^9, 3.7522526904388638`*^9}, {3.75225274157722*^9, 
   3.752252766458064*^9}, 3.752252904850363*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"fUnravel", "[", "lTree__", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"len", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Length", "@", "lTree"}], ")"}], "-", "1"}]}], ",", "lDeps", 
      ",", "lAll"}], "}"}], ",", 
    RowBox[{
     RowBox[{"lDeps", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Depth", "@", 
         RowBox[{
          RowBox[{"lTree", "[", 
           RowBox[{"[", "i", "]"}], "]"}], "[", 
          RowBox[{"[", "5", "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "len", ",", "1"}], "}"}]}], "]"}]}], ";", 
     RowBox[{"lAll", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"lTree", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "5", "]"}], "]"}], ",", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"lDeps", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "-", "4"}], ">", "0"}], ",", 
            RowBox[{
             RowBox[{"lDeps", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "-", "4"}], ",", "0"}], "]"}]}],
          "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "len", ",", "1"}], "}"}]}], "]"}]}], ";", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"i", "\[Equal]", "1"}], ",", 
         RowBox[{"{", 
          RowBox[{"lAll", "[", 
           RowBox[{"[", "i", "]"}], "]"}], "}"}], ",", 
         RowBox[{"lAll", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "len", ",", "1"}], "}"}]}], "]"}]}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.752252346224621*^9, 3.752252453260181*^9}, {
  3.752252530673006*^9, 3.752252602699275*^9}, {3.7522528034847803`*^9, 
  3.75225286078447*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"lAnimations", "=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"ListPlot", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"fUnravel", "[", "test", "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
      RowBox[{"Joined", "\[Rule]", "True"}], ",", 
      RowBox[{"PlotMarkers", "\[Rule]", "Automatic"}], ",", 
      RowBox[{"PlotRange", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"3.", ",", "7"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"3.", ",", "7."}], "}"}]}], "}"}]}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1", ",", 
      RowBox[{
       RowBox[{"Length", "@", "test"}], "-", "1"}], ",", "1"}], "}"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7522524547097692`*^9, 3.75225245680367*^9}, {
  3.752252607420631*^9, 3.7522527829227343`*^9}, {3.7522528646005993`*^9, 
  3.752252894408337*^9}, {3.752252936773143*^9, 3.7522529844610023`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.8, 5.}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.8, 
         5.}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}], ",", 
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.751819588855465, 5.199696735190756}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.751819588855465, 
         5.199696735190756}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}], ",", 
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.751819588855465, 5.199696735190756}, {
         4.851819588855466, 4.799696735190755}, {4.905719294220258, 
         4.60257546577551}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.751819588855465, 
         5.199696735190756}}, {{4.851819588855466, 4.799696735190755}}, {{
         4.905719294220258, 4.60257546577551}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}], ",", 
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.751819588855465, 5.199696735190756}, {
         4.851819588855466, 4.799696735190755}, {4.905719294220258, 
         4.60257546577551}, {4.960109654332367, 4.412132742248554}, {
         5.013546162804101, 4.231234176711491}, {5.066393874800715, 
         4.051363453917015}, {5.116226044398907, 3.8843837025709393`}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.751819588855465, 
         5.199696735190756}}, {{4.851819588855466, 4.799696735190755}}, {{
         4.905719294220258, 4.60257546577551}}, {{4.960109654332367, 
         4.412132742248554}}, {{5.013546162804101, 4.231234176711491}}, {{
         5.066393874800715, 4.051363453917015}}, {{5.116226044398907, 
         3.8843837025709393`}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}], ",", 
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.751819588855465, 5.199696735190756}, {
         4.851819588855466, 4.799696735190755}, {4.905719294220258, 
         4.60257546577551}, {4.960109654332367, 4.412132742248554}, {
         5.013546162804101, 4.231234176711491}, {5.066393874800715, 
         4.051363453917015}, {5.116226044398907, 3.8843837025709393`}, {
         5.162490417467922, 3.7308053799534613`}, {5.204910624951955, 
         3.5905500425554453`}, {5.247295029719619, 3.4500595088604897`}, {
         5.285843113924584, 3.321641686923781}, {5.328357428562326, 
         3.1803034530403282`}, {5.367501719014135, 3.0489659288273687`}, {
         5.38209207864963, 3.}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.751819588855465, 
         5.199696735190756}}, {{4.851819588855466, 4.799696735190755}}, {{
         4.905719294220258, 4.60257546577551}}, {{4.960109654332367, 
         4.412132742248554}}, {{5.013546162804101, 4.231234176711491}}, {{
         5.066393874800715, 4.051363453917015}}, {{5.116226044398907, 
         3.8843837025709393`}}, {{5.162490417467922, 3.7308053799534613`}}, {{
         5.204910624951955, 3.5905500425554453`}}, {{5.247295029719619, 
         3.4500595088604897`}}, {{5.285843113924584, 3.321641686923781}}, {{
         5.328357428562326, 3.1803034530403282`}}, {{5.367501719014135, 
         3.0489659288273687`}}, {{5.38209207864963, 
         3.}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}], ",", 
   GraphicsBox[{{}, {{{}, {}, 
       {RGBColor[0.368417, 0.506779, 0.709798], PointSize[
        0.012833333333333334`], AbsoluteThickness[1.6], 
        LineBox[{{4.8, 5.}, {4.751819588855465, 5.199696735190756}, {
         4.851819588855466, 4.799696735190755}, {4.905719294220258, 
         4.60257546577551}, {4.960109654332367, 4.412132742248554}, {
         5.013546162804101, 4.231234176711491}, {5.066393874800715, 
         4.051363453917015}, {5.116226044398907, 3.8843837025709393`}, {
         5.162490417467922, 3.7308053799534613`}, {5.204910624951955, 
         3.5905500425554453`}, {5.247295029719619, 3.4500595088604897`}, {
         5.285843113924584, 3.321641686923781}, {5.328357428562326, 
         3.1803034530403282`}, {5.367501719014135, 3.0489659288273687`}, {
         5.38209207864963, 3.}}]}}, {
       {RGBColor[0.368417, 0.506779, 0.709798], AbsolutePointSize[6], 
        AbsoluteThickness[1.6], GeometricTransformationBox[InsetBox[
          StyleBox["\<\"\[FilledCircle]\"\>",
           StripOnInput->False,
           FontSize->8.96], {0., 0.}], {{{4.8, 5.}}, {{4.751819588855465, 
         5.199696735190756}}, {{4.851819588855466, 4.799696735190755}}, {{
         4.905719294220258, 4.60257546577551}}, {{4.960109654332367, 
         4.412132742248554}}, {{5.013546162804101, 4.231234176711491}}, {{
         5.066393874800715, 4.051363453917015}}, {{5.116226044398907, 
         3.8843837025709393`}}, {{5.162490417467922, 3.7308053799534613`}}, {{
         5.204910624951955, 3.5905500425554453`}}, {{5.247295029719619, 
         3.4500595088604897`}}, {{5.285843113924584, 3.321641686923781}}, {{
         5.328357428562326, 3.1803034530403282`}}, {{5.367501719014135, 
         3.0489659288273687`}}, {{5.38209207864963, 
         3.}}}]}, {}}}, {}, {}, {{}, {}}},
    AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
    Axes->{True, True},
    AxesLabel->{None, None},
    AxesOrigin->{3.02, 3.02},
    DisplayFunction->Identity,
    Frame->{{False, False}, {False, False}},
    FrameLabel->{{None, None}, {None, None}},
    FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
    GridLines->{None, None},
    GridLinesStyle->Directive[
      GrayLevel[0.5, 0.4]],
    ImagePadding->All,
    Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& ), "CopiedValueFunction" -> ({
          (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
           Part[#, 1]], 
          (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
           Part[#, 2]]}& )}},
    PlotRange->{{3., 7}, {3., 7.}},
    PlotRangeClipping->True,
    PlotRangePadding->{{0, 0}, {0, 0}},
    Ticks->{Automatic, Automatic}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.7522524572325*^9, 3.7522525358117228`*^9, {3.752252604274835*^9, 
   3.75225278339375*^9}, {3.75225286190696*^9, 3.752252906868136*^9}, {
   3.752252950720606*^9, 3.752252985133519*^9}, 3.752253027757452*^9}]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1406, 1008},
WindowMargins->{{Automatic, 331}, {112, Automatic}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 289, 6, 32, "Input"],
Cell[850, 28, 13647, 360, 663, "Input"],
Cell[14500, 390, 390, 10, 32, "Input"],
Cell[CellGroupData[{
Cell[14915, 404, 265, 6, 32, "Input"],
Cell[15183, 412, 2709, 56, 249, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[17929, 473, 103, 1, 64, "Section"],
Cell[18035, 476, 381, 10, 32, "Input"],
Cell[CellGroupData[{
Cell[18441, 490, 122, 2, 32, "Input"],
Cell[18566, 494, 73, 1, 32, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[18676, 500, 324, 7, 32, "Input"],
Cell[19003, 509, 360, 9, 32, "Output"]
}, Open  ]],
Cell[19378, 521, 240, 6, 32, "Input"],
Cell[CellGroupData[{
Cell[19643, 531, 352, 9, 32, "Input"],
Cell[19998, 542, 297, 5, 282, "Output"]
}, Open  ]],
Cell[20310, 550, 8181, 204, 453, "Input"],
Cell[CellGroupData[{
Cell[28516, 758, 238, 6, 32, "Input"],
Cell[28757, 766, 710, 21, 32, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[29504, 792, 831, 21, 32, "Input"],
Cell[30338, 815, 990, 27, 32, "Output"]
}, Open  ]],
Cell[31343, 845, 1087, 24, 75, "Input"],
Cell[32433, 871, 817, 17, 32, "Input"],
Cell[33253, 890, 2052, 59, 75, "Input"],
Cell[CellGroupData[{
Cell[35330, 953, 1065, 28, 32, "Input"],
Cell[36398, 983, 13462, 263, 144, "Output"]
}, Open  ]]
}, Open  ]]
}
]
*)

